@using System.Security.Claims
@using System.Collections
@{
    ViewData["Title"] = "Approved Contributors";
}
@{
    ViewBag.Title = "Approved Contributors";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.6/css/responsive.dataTables.min.css" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<h1>Approved Contributors: @ViewBag.SubRoleName</h1>
@{
    var userRole = @User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
}
<input type="hidden" id="UserRole" value="@userRole" />
<input type="hidden" id="SubRole" value="@ViewBag.SubRole" />
<label id="lblMessage" name="lblMessage" class="errorMessage"></label>
<div style="width: 1800px">
    <table class="table table-striped table-bordered table-hover" id="ContributorTable" cellspacing="0" align="center"></table>
</div>

<div id="rating-dialog" style="display: none"></div>
<div id="assignedAnnotators-dialog" style="display: none"></div>
<div id="assignedBlockPrompts-dialog" style="display: none"></div>

<div id="contributorRecordings-dialog" style="display: none"></div>
<div id="listen-dialog" style="display: none">
    <p>
        <b>ContributorID:</b><label id="lblListenContributorId" name="lblListenContributorId"></label>
        <br/>
        <b>Transcript:</b><label id="lblListenTranscript" name="lblListenTranscript"></label>
        <br/>
        <input type="hidden" id="hidFileName"/>
        <audio id="listenRecording" controls>
            <source src="">
        </audio>

    </p>
</div>
<div id="sendFollowUp-dialog" style="display: none">
    <label id="lblFollowUpMessage">Send follow-up message to below Contributor:</label>
    <input type="hidden" id="hidFollowUpContributorId" />
    <br /><b>First Name:</b><label id="lblFollowUpFirstName" name="lblFollowUpFirstName"></label>
    <br /><b>Last Name:</b><label id="lblFollowUpLastName" name="lblFollowUpLastName"></label>
    <br /><b>Email Address:</b><label id="lblFollowUpEmail" name="lblFollowUpEmail"></label>
    <br />Message to the Contributor:<br />
    <textarea id="txtFollowUpMessage" name="txtFollowUpMessage" rows="4" cols="50">

</textarea>

</div>
<div id="editInfo-dialog" style="display: none">
    <label id="lblEditInfoMessage">Contributor:</label>
    <input type="hidden" id="hidEditInfoContributorId" />
    <br /><b>First Name:</b><label id="lblEditInfoFirstName" name="lblEditInfoFirstName"></label>
    <br /><b>Last Name:</b><label id="lblEditInfoLastName" name="lblEditInfoLastName"></label>
    <br /><b>Year of Birth:</b><input type="text" id="txtEditInfoBirthYear" name="txtEditInfoBirthYear" />
    <br/><br /><b>Contributor Email:</b><input type="text" id="txtEditContributorEmail" name="txtEditContributorEmail" />
    <br/><br/><b>Helper Email:</b><input type="text" id="txtEditHelperEmail" name="txtEditHelperEmail" />
    &nbsp;&nbsp;&nbsp;<b>Helper Phone:</b><input type="text" id="txtEditHelperPhone" name="txtEditHelperPhone" />
    <br />Comment:<br /><textarea id="txtEditInfoComment" name="txtEditInfoComment" rows="4" cols="50"></textarea>
    <br /><b>Status:</b>
    <select id="dlSubStatus" asp-items="@ViewBag.SubStatus"></select>
</div>

@*<div id="editSubStatus-dialog" style="display: none">
    <label id="lblEditSubStatusMessage">Contributor:</label>
    <input type="hidden" id="hidEditSubStatusContributorId" />
    <br /><b>First Name:</b><label id="lblEditSubStatusFirstName" name="lblEditSubStatusFirstName"></label>
    <br /><b>Last Name:</b><label id="lblEditSubStatusLastName" name="v"></label>
    <br /><b>Status:</b>
    <select id="SubStatus" asp-items="@ViewBag.SubStatus"></select>
</div>
*@
<div class="spinner" style="display:none">
    <div class="center-div">
        <div class="inner-div">
            <div class="loader"></div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.6/js/dataTables.responsive.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/2.1.2/jquery.scrollTo.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="~/js/listenrecording.js"></script>
    <script src="~/js/Contributor.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {

            //bind datatable for Contributor
            var oContributorTable = $("#ContributorTable").on('error.dt',
                function (e, settings, techNote, message) {
                    alert('Error loading the data. It could be the timeout issue. Please try to reload your browser. ', message);
                }).DataTable({
                    "serverSide": true,
                    "processing": true,
                    "responsive": true,
                    "iDisplayLength": 100,
                    "dom": "<'row'<'col-sm-4'l><'col-sm-4'i><'col-sm-4'f>>" +
                        "<'row'<'col-sm-12'tr>>p",
                    "ajax": ({
                        "url": '@Url.Action("LoadContributors", "Contributor")',
                        "data": { "subRole": $("#SubRole").val(), "filter": 2 },
                        "type": "POST",
                        "datatype": "json"
                    }),
                    "bAutoWidth": false,
                    "aaSorting": [[8, 'desc']],
                    "columns": [
                         {
                             "title": "View Blocks",
                            "className": 'details-control',
                            "orderable": false,
                            "data": null,
                            "defaultContent": '',
                            "width": "10px"
                        },
                        {
                            "title": "ID",
                            "data": "contributor.id",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.Id",
                            "width": "250px"
                        },

                        {
                            "title": "FirstName",
                            "data": "contributor.firstName",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.FirstName"
                        },
                      
                        {
                            "title": "LastName",
                            "data": "contributor.lastName",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.LastName"
                        },
                        {
                            "title": "BYear",
                            "data": "contributor.birthYear",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.irthYear"
                        },
                        {
                            "title": "Gender",
                            "data": null,
                            "searchable": true,
                            "orderable": false,
                            "visible": true,
                            "name": null,
                            "render": function (data, type, row) {
                                if (data.contributor.contributorDetails.length>0) {
                                    //return data.contributor.contributorDetails[0].gender;
                                    return data.contributor.contributorDetails[0].gender; //data.contributor.contributorDetails.length;
                                }
                                else
                                {
                                    return '';
                                }
                                
                            }
                        },
                        {
                            "title": "HelperEmail",
                            "data": "contributor.helperEmail",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.HelperEmail",
                            "render": function (data, type, row) {
                                if (row.contributor.helperInd == "Yes")
                                    return row.contributor.helperEmail
                                return '';
                            }
                        },

                        {
                            "title": "HelperPhone",
                            "data": "contributor.helperPhoneNumber",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.HelperPhoneNumber",
                            "render": function (data, type, row) {
                                if (row.contributor.helperInd == "Yes")
                                    return row.contributor.helperPhoneNumber
                                return '';
                            }
                        },
                        {
                            "title": "AppDate",
                            "data": "contributor.approveTS",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.ApproveTS",
                            "render": function (data) {
                                if(data != null){
                                    var date = new Date(data);
                                    var month = date.getMonth() + 1;
                                    return (month.toString().length > 1 ? month : "0" + month) + "/" + date.getDate() + "/" + date.getFullYear();
                                }
                                return '';
                                
                            }
                        },
                        {
                            "title": "#BLocks",
                            "data": "numberAssignBlocks",
                            "searchable": true,
                            "orderable": false,
                            "visible": true,
                            "name": "NumberAssignBlocks"
                        },
                        {
                            "title": "LastRecording",
                            "data": "lastRecording",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "LastRecording",
                            "render": function (data) {
                                if(data!= null)
                                {
                                    var date = new Date(data);
                                    var month = date.getMonth() + 1;
                                    return (month.toString().length > 1 ? month : "0" + month) + "/" + date.getDate() + "/" + date.getFullYear() + "&nbsp;" + (date.getHours() < 10 ? ("0" + date.getHours()) : date.getHours()) + ":" + (date.getMinutes() < 10 ? ("0" + date.getMinutes()) : date.getMinutes());

                                }
                                return '';
                            
                            }
                        },
                        {
                            "title": "AnnAssigned ",
                            "data": "annotatorAssigned",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "AnnotatorAssigned"
                        },
                        {
                            "title": "SentFollowUpDate",
                            "data": "followUpDate",
                            "searchable": true,
                            "orderable": false,
                            "visible": true,
                            "name": "",
                            "render": function (data) {
                                if (data != "") {
                                    var date = new Date(data);
                                    var month = date.getMonth() + 1;
                                    return (month.toString().length > 1 ? month : "0" + month) + "/" + date.getDate() + "/" + date.getFullYear() + "&nbsp;" + (date.getHours() < 10 ? ("0" + date.getHours()) : date.getHours()) + ":" + (date.getMinutes() < 10 ? ("0" + date.getMinutes()) : date.getMinutes());

                                }
                                return '';

                            }
                        },
                        {
                            "title": "Status",
                            "data": "approvedStatus",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "ApprovedStatus",
                            //"render": function (data, type, row) {
                            //    if (data.contributor.contributorSubStatus == null) {
                            //        return '';
                            //    }
                            //    return data.contributor.contributorSubStatus.name;
                            //}
                        },
                        {
                            "title": "Comments",
                            "data": "contributor.comments",
                            "searchable": true,
                            "orderable": true,
                            "visible": true,
                            "name": "Contributor.Comments"
                        },

                        {
                            "title": "Actions",
                            "data": "contributor.id",
                            //"targets": 0,
                            "searchable": false,
                            "orderable": false,
                            "width": '250px',
                            "classDescription": 'dt-body-center',
                            "visible": true,
                            "name": "Contributor.Id",
                            "render": function (data, type, row) {
                                var link="";
                                if ($("#UserRole").val() === "TextAnnotatorAdmin" || $("#UserRole").val() === "SystemAdmin") {
                                    link = '<a href="#" class="assignAnnotator" >Assign Annotators</a> | <a href="#" class="viewSITRating" >View SIT Rating</a><br>|'
                                        + ' <a href="#" class="sendFollowUp">Send Follow-up </a>'
                                        + '| <a href="#" class="editInfo">Edit Info</a> ';
                                    return link;
                                }
                                link = '<a href="#" class="viewSITRating" >View SIT Rating</a> '
                                    + ' <a href="#" class="sendFollowUp">Send Follow-up </a>'
                                    + '| <a href="#" class="editInfo">Edit Info</a> ';
                                return link;
                               
                            }
                        }
                    ],
                    "ordering": true,
                    "paging": true,
                    "pageLength": 100,
                    "lengthMenu": [[25, 50, 100, 3000], [25, 50, 100, 3000]]
                });


            $('#ContributorTable tbody').on('click',
                'td.details-control',
                function() {
                    var tr = $(this).closest('tr');
                    var row = oContributorTable.row(tr);
                    var contributorId = oContributorTable.row(this).data().contributor.id;
                                       

                    if (row.child.isShown()) {
                        // This row is already open - close it
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                         //close other child rows
                        oContributorTable.rows().every(function () {
                            var row = this;
                            if (row.child.isShown()) {
                                row.child.hide();
                                $(this.node()).removeClass('shown');                            
                            }
                        });

                        // Open this row
                        row.child(formatDataTableDetailRow(contributorId)).show();
                        tr.addClass('shown');
                        buildContributorAssignedBlocksTable(contributorId);
                    }
                   

                });

            function buildContributorAssignedBlocksTable(contributorId) {
                $.ajax({
                    url: '@Url.Action("LoadContributorAssignedBlocks", "SpeechFile")',
                    type: 'POST',
                    data: {
                        'contributorId': contributorId,
                        'subRole': $("#SubRole").val()
                    },
                    success: function (data) {
                        var recordingList = $("#AssignedBlocks_" + contributorId);
                        recordingList.html(data);
                        
                    },
                    error: function () {
                        alert("Error loading Contributor Assigned Blocks");
                    }
                });

            }
            function formatDataTableDetailRow(contributorId) {
                return '<div id="AssignedBlocks_' + contributorId + '"></div>';

            }



            // view SIT Rating
            $('#ContributorTable').on('click', 'a.viewSITRating', function (e) {
                e.preventDefault();
                var selectedRowData = oContributorTable.row($(this).closest('tr'));
                var row = selectedRowData.data();
                var getUrl = "@Url.Action("ViewSITRecordingRating", "SpeechFile")?contributorId=" + row.contributor.id + "&subRole=" + $("#SubRole").val();
                //$("#lblContributor").text(row.id);
                getRecordingRating(getUrl);
                $("#rating-dialog").dialog('open');
                return false;
            });
            function getRecordingRating(getUrl) {
                $("#rating-dialog").dialog({
                    title: "SIT Speech File Rating",
                    autoOpen: false,
                    resizable: false,
                    width: 1000,
                    height: 700,
                    show: { effect: 'drop', direction: "up" },
                    modal: true,
                    draggable: true,
                    closeOnEscape: true,
                    position: { my: "left top", at: "left+50 top+100", of: window },

                    open: function () {
                        $(this).load(getUrl);
                        //$('#rating-dialog').css('overflow', 'hidden'); //hide the vertial bar on the dialog
                    },
                    close: function () {
                        $("#rating-dialog").empty();
                    },
                    buttons: {

                        close: function () {
                            $("#rating-dialog").empty();
                            $(this).dialog('close');
                        }
                    }

                });
            }


            // assign Annotators
            $('#ContributorTable').on('click', 'a.assignAnnotator', function (e) {
                e.preventDefault();
                var selectedRowData = oContributorTable.row($(this).closest('tr'));
                var row = selectedRowData.data();
                var getUrl = "@Url.Action("GetAssignContributorAnnotators", "Contributor")?contributorId=" + row.contributor.id;
                //$("#lblContributor").text(row.id);
                getAnnotators(getUrl);
                $("#assignedAnnotators-dialog").dialog('open');
                return false;
            });
            function getAnnotators(getUrl) {
                $("#assignedAnnotators-dialog").dialog({
                    title: "Assign Annotators",
                    autoOpen: false,
                    resizable: false,
                    width: 1000,
                    height: 700,
                    show: { effect: 'drop', direction: "up" },
                    modal: true,
                    draggable: true,
                    closeOnEscape: true,
                    position: { my: "left top", at: "left+50 top+100", of: window },

                    open: function () {
                        $(this).load(getUrl);
                        //$('#rating-dialog').css('overflow', 'hidden'); //hide the vertial bar on the dialog
                    },
                    close: function () {

                    },
                    buttons: {

                        close: function () {

                            $(this).dialog('close');
                        }
                    }

                });
            }

            //send follow up message to the contributor
            $('#ContributorTable').on('click',
                'a.sendFollowUp',
                function (e) {
                    e.preventDefault();
                    var selectedRowData = oContributorTable.row($(this).closest('tr'));
                    var row = selectedRowData.data();
                    $("#hidFollowUpContributorId").val(row.contributor.id);
                    $("#lblFollowUpFirstName").text(row.contributor.firstName);
                    $("#lblFollowUpLastName").text(row.contributor.lastName);
                    $("#lblFollowUpEmail").text(row.contributor.emailAddress);
                    var content = "Dear " + row.contributor.firstName + ",\n\nSincerely,\n Speech Accessibility Project Team\nUniversity of Illinois Urbana - Champaign";
                    $("#txtFollowUpMessage").val(content);
                    sendFollowUpContributor('@Url.Action("SendFollowUpToContributor", "Contributor")', oContributorTable);
                    $("#sendFollowUp-dialog").dialog('open');

                });
           
            
             //Edit Info
            $('#ContributorTable').on('click',
                'a.editInfo',
                function (e) {
                    e.preventDefault();
                    var selectedRowData = oContributorTable.row($(this).closest('tr'));
                    var row = selectedRowData.data();
                    $("#lblEdiInfoMessage").text("Update Contributor Information:");
                    $("#hidEditInfoContributorId").val(row.contributor.id);
                    $("#lblEditInfoFirstName").text(row.contributor.firstName);
                    $("#lblEditInfoLastName").text(row.contributor.lastName);
                    $("#txtEditContributorEmail").val(row.contributor.emailAddress);
                    $("#txtEditHelperEmail").val(row.contributor.helperEmail);
                    $("#txtEditInfoBirthYear").val(row.contributor.birthYear);
                    //if (row.contributor.helperInd == "Yes")
                    //    $("#txtEditHelperEmail").prop("disabled", false);
                    //else
                    //    $("#txtEditHelperEmail").prop("disabled", true);
                    if (row.contributor.helperInd == "Yes") {
                        $("#txtEditHelperEmail").prop("disabled", false);
                        $("#txtEditHelperPhone").prop("disabled", false);
                       
                    }
                        
                    else
                    {
                        $("#txtEditHelperEmail").prop("disabled", true);
                        $("#txtEditHelperPhone").prop("disabled", true);
                        
                    }

                    $("#txtEditInfoComment").val(row.contributor.comments);
                    $("#dlSubStatus").val(row.contributor.subStatusId).trigger("chosen:updated");
                    editContributorInfo('@Url.Action("EditContributorInfo", "Contributor")', oContributorTable, "Edit Contributor Information",2);
                    $("#editInfo-dialog").dialog('open');

            });

         


        });//End document ready

    </script>
}
